<!DOCTYPE html>
<!--
    Based upon Striped 2.5 by HTML5 Up!
    html5up.net | @n33co
    Updated for Jekyll by Paul Fenwick | @pjf
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">
    <head>
        <title>Intruder Alert - Tracking down a rogue connection</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        <link rel="alternative" type="application/rss+xml" title="RSS" href="/feed.xml"/>
        <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700|Open+Sans+Condensed:300,700" rel="stylesheet" />
        <script src="/js/jquery.min.js"></script>
        <script src="/js/skel.min.js"></script>
        <script src="/js/skel-panels.min.js"></script>
        <script src="/js/init.js"></script>
        <noscript>
            <link rel="stylesheet" href="/css/skel-noscript.css" />
            <link rel="stylesheet" href="/css/style.css" />
            <link rel="stylesheet" href="/css/style-desktop.css" />
            <link rel="stylesheet" href="/css/style-wide.css" />
        </noscript>
        <!--[if lte IE 9]><link rel="stylesheet" href="css/ie9.css" /><![endif]-->
        <!--[if lte IE 8]><script src="js/html5shiv.js"></script><link rel="stylesheet" href="css/ie8.css" /><![endif]-->
        <!--[if lte IE 7]><link rel="stylesheet" href="css/ie7.css" /><![endif]-->

        <link rel="stylesheet" href="/css/pjf.css" />

    </head>
    <!--
        Note: Set the body element's class to "left-sidebar" to position the sidebar on the left.
        Set it to "right-sidebar" to, you guessed it, position it on the right.
    -->
    <body class="left-sidebar">
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-47199716-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

        <div id="wrapper">
            <div id="content">
                <div id="content-inner">
                    
    


<article class="is-post">
    <header>
    <!--
            Note: Titles and bylines will wrap automatically when necessary, so don't worry
            if they get too long. You can also remove the "byline" span entirely if you don't
            need a byline.
    -->
    <h2><a href="#">Intruder Alert - Tracking down a rogue connection</a></h2>
    <!-- <span class="byline">A free, fully responsive HTML5 site template by AJ for HTML5 UP</span> -->
</header>

    <div class="info">
    <!--
            Note: The date should be formatted exactly as it's shown below. In particular, the
            "least significant" characters of the month should be encapsulated in a <span>
            element to denote what gets dropped in 1200px mode (eg. the "uary" in "January").
            Oh, and if you don't need a date for a particular page or post you can simply delete
            the entire "date" element.
            
    -->
    <!-- <span class="date"><span class="month">Jan<span>uary</span></span> <span class="day">14</span><span class="year">, 2013</span></span> -->
    <span class="date">
        <span class="month">Nov</span>
        <span class="day">21</span>
        <span class="year"><span>,</span> 2007</span>
    </span>


    <!-- Note: You can change the number of list items in "stats" to whatever you want. -->

    <!--
        <ul class="stats">
            <li><a href="#" class="fa fa-comment">16</a></li>
            <li><a href="#" class="fa fa-heart">32</a></li>
            <li><a href="#" class="fa fa-twitter">64</a></li>
            <li><a href="#" class="fa fa-facebook">128</a></li>
        </ul>
    -->
</div>


    <p><b>Intruder Alert - Tracking down a rogue connection</b><br />
The hosts I administer look through their logfiles each hour, looking for things that are out of the ordinary, and mailing them to me.  This is where my uncanny ability to remember leap-seconds comes from; it's not because I actually <i>care</i> about things, but because I'll get an e-mail saying that a host suddenly found itself a <i>whole second</i> out of sync with some incredibly accurate clock somewhere.  Lucky me.
<p>
Most things <i>don't</i> end up in my log digests, because most things are boring.  The things I do see are things that I either care about, or have never seen before.
<p>
A few days ago I got an e-mail that one machine was trying to contact a particular address, 172.16.45.35.  What made this noteworthy is that address is <i>unroutable</i>.  It's a reserved, private address space.  It doesn't go <i>anywhere</i> on the Internet, and it's not used by us internally, so there should be no reason to try and contact it.  The connection indicated it would have been an outgoing web request, and since I was busy working on other things, I assumed that some other fool had set up <i>their</i> system incorrectly, and thought nothing of it.  People leave references to their own internal sites in documents all the time.
<p>
A few days later I got another e-mail, same result.  And then another, the next day, and another.  Each time I looked a little closer.  About the same time each day, a few attempts to contact this address, and then nothing.
<p>
Today, this bothered me.  What if we're seeing these packets because there's something running on this machine that shouldn't be?  So I go to my proxy logs, and do a search for the address.  Nothing matches.
<p>
Hmm, that's odd.  Let's see what's in our name-server cache, since the address is probably the result of a name lookup.  <tt>kill -INT</tt> on your <tt>named</tt> will let you see its memory cache, a great trick to remember.  Nothing in here, either, but it's now been hours since I got the mail, so the record may well have expired.
<p>
What's odd about this connection is that it seems to happen around lunchtime, but not every day, and not always exactly the same time, and sometimes it misses days, so I don't really know if or when I'll ever see it again.  Rather than trying to futilely trying to find it <i>minutes</i> after it occurs, I figure that I'll set something running to catch it in the act:

<blockquote>
<tt>lsof -r1 +c0 -ni@172.16.45.35 | grep --line-buffered -v ======= | tee 172.16.45.35-watch</tt>
</blockquote>
<p>
Every second I'll look for anything involving that address using <tt>lsof</tt>, remove the boring separators, and chuck it into a file and STDOUT.  The <tt>--line-buffered</tt> option is important so that <tt>grep</tt> doesn't delay the flow of data.
<p>
While I've got that running, I whip up a bit of perl to watch the output, and grab fingerprints of the process when we spot it; most of the contents of the relevant entry in <tt>/proc</tt> will do nicely.
<p>
I leave my tools to run in a <tt>screen</tt> session (which will preserve them even if my terminal goes away), make dinner, have an extremely nice home-brew beer, and watch some TV.  In this case, House MD.
<p>
As is common in many episodes of House, the patient is sick with a disease that <i>should</i> have been obvious, since they test for that particular disease in every single episode (expect this one).  Not long afterwards, it dawns upon me what <i>my</i> problem may be.
<p>
I go to the proxy logs, and I look up <i>all</i> the addresses of <i>all</i> the sites accessed today:

<blockquote><tt>
perl -pe'my @f = split(/\s+/,$_); $_ = $f[6]; s{^http://}{}; s{[:/].*}{}; $_ .= "\n"' access.log | sort | uniq | perl -MIO::Handle -MNet::DNS -e'my $dns = Net::DNS::Resolver-&gt;new; STDOUT-&gt;autoflush(1); while (&lt;&gt;) { chomp; print "== $_ ==\n"; my $q = $dns-&gt;search($_); if ($q) { foreach my $rr ($q-&gt;answer) { print $rr-&gt;address,"\n" if $rr-&gt;type eq "A" } } else { warn $dns-&gt;errorstring; } }' | tee /tmp/squid-dns
</tt></blockquote>
<p>
Sure enough, after a few moments my answer pops out!  The address <tt>proof.smh.com.au</tt> resolves to 172.16.45.35.  SMH is the Sydney Morning Herald, and it looks like some of their pages refer to an internal machine, which my reporting system is dutifully reporting as odd.  Sure enough, all the dates and times in the squid logfiles match up nicely with the packet intercept reports I was sent.
<p>
The reason it wasn't showing up when I first searched is that squid only records IP addresses when it needs to make a direct connection.  In this case, it <i>tried</i> to make the connection and failed, but rather than giving up it then proceeds to try and hand the problem off to an upstream cache, and <i>that's</i> what gets reporting in the logfile.
<p>
This is good for me, since it means that the odd connections really are what I thought they would be, and not a sign of unwanted activity on one of my machines.  I'm doubly glad because it would be especially embarrassing to find a rootkit that's so badly written that it tries connecting to a completely unroutable address.


    <div class="tip-box">
    <p>
        <a href="http://gittip.com/pjf"><i class="fa fa-gittip fa-3x pull-left"></i></a>
        This content is available for you to use for free,
        even commercially, under a <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 license</a>.
    </p><p>
        If you wish to support my work,
        please <a href="http://gittip.com/pjf">tip me on
        gittip</a>.
    </p>
</div>


    <div id="disqus_thread"></div>
<script type="text/javascript">

    var disqus_shortname  = 'pjf'; 
    var disqus_identifier = '/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html';
    var disqus_title      = 'Intruder Alert - Tracking down a rogue connection';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



</article>


                    


                </div>
            </div>

            <!-- Sidebar -->
<div id="sidebar">
    <!-- Logo -->
    <div id="logo"><h1><a href="/">pjf</a></h1></div>

    <section class="find_me">
        <a href="http://twitter.com/pjf"><i class="fa fa-twitter-square  fa-3x"  ></i></a>
        <a href="http://facebook.com/paul.fenwick"><i class="fa fa-facebook-square fa-3x"  ></i></a>
        <a href="http://github.com/pjf"><i class="fa fa-github-square   fa-3x"  ></i></a>
    </section>

    <!-- Nav -->
    <nav id="nav">
        <ul>
            <!-- <li class="current_page_item"><a href="/"></a></li> -->
            <li><a href="/">Latest Post</a></li>
            <li><a href="/talks">My Talks</a></li>
            <li><a href="/DF">Dwarf Fortress</a></li>
            <li><a href="/advogato">Older Posts</a></li>
        </ul>
    </nav>

    <!-- Search -->
    <!-- <section class="is-search">
        <form method="post" action="#">
            <input type="text" class="text" name="search" placeholder="Search" />
        </form>
    </section> -->

    <!-- Text -->
    <section class="is-text-style1">
        <div class="inner">
            <p>
                <a href="http://gittip.com/pjf">
                    <i class="fa fa-gittip fa-3x pull-left"></i>
                </a>
                Everything on this site is free for you to use
                under the <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a> license.
            </p>
        </div>
    </section>

    <!-- Recent Posts -->
    <section class="is-recent-posts">
        <header>
            <h2>Recent Posts</h2>
        </header>

        <ul>
        
            <li><a href="/tech/2014/01/16/use-markdown-rather-than-bbcode-with-vimperator.html">Use Markdown Instead Of BBCode With Vimperator</a>
        
            <li><a href="/df/unholinesssparked/2014/01/11/jaxys-greatest-wish.html">Jaxy's Greatest Wish</a>
        
            <li><a href="/df/unholinesssparked/2014/01/11/a-quiet-trade.html">A Quiet Trade</a>
        
            <li><a href="/df/unholinesssparked/2014/01/11/a-place-to-settle.html">A Place To Settle</a>
        
            <li><a href="/df/unholinesssparked/2014/01/07/the-fickleness-of-warlocks.html">The Fickleness Of Warlocks</a>
        
            <li><a href="/df/unholinesssparked/2014/01/07/a-family-reunion.html">A Family Reunion</a>
        
            <li><a href="/df/unholinesssparked/2014/01/06/a-matter-of-trade.html">A Matter Of Trade</a>
        
            <li><a href="/df/unholinesssparked/2014/01/05/a-home-in-the-wilderness.html">A Home In The Wilderness</a>
        
            <li><a href="/longpost/2013/12/28/on-open-source-software-and-communities.html">On Open Source Software And Communities</a>
        
            <li><a href="/talks/2013/07/26/fear-uncertainty-and-dopamine.html">Fear, Uncertainty, and Dopamine</a>
        
        </ul>
    </section>

    <!-- Recent Comments -->
    <!-- <section class="is-recent-comments">
        <header>
            <h2>Recent Comments</h2>
        </header>
        <ul>
            <li>case on <a href="#">Now Full Cyborg</a></li>
            <li>molly on <a href="#">Untitled Post</a></li>
            <li>case on <a href="#">Temporal Flux</a></li>
        </ul>
    </section> -->

    <!-- Calendar -->

    <!-- <section class="is-calendar">
        <div class="inner">
            <table>
                <caption>February 2013</caption>
                <thead>
                    <tr>
                        <th scope="col" title="Monday">M</th>
                        <th scope="col" title="Tuesday">T</th>
                        <th scope="col" title="Wednesday">W</th>
                        <th scope="col" title="Thursday">T</th>
                        <th scope="col" title="Friday">F</th>
                        <th scope="col" title="Saturday">S</th>
                        <th scope="col" title="Sunday">S</th>
                    </tr>
            </thead>
            <tbody>
                    <tr>
                        <td colspan="4" class="pad"><span>&nbsp;</span></td>
                        <td><span>1</span></td>
                        <td><span>2</span></td>
                        <td><span>3</span></td>
                    </tr>
                    <tr>
                        <td><span>4</span></td>
                        <td><span>5</span></td>
                        <td><a href="#">6</a></td>
                        <td><span>7</span></td>
                        <td><span>8</span></td>
                        <td><span>9</span></td>
                        <td><a href="#">10</a></td>
                    </tr>
                    <tr>
                        <td><span>11</span></td>
                        <td><span>12</span></td>
                        <td><span>13</span></td>
                        <td class="today"><a href="#">14</a></td>
                        <td><span>15</span></td>
                        <td><span>16</span></td>
                        <td><span>17</span></td>
                    </tr>
                    <tr>
                        <td><span>18</span></td>
                        <td><span>19</span></td>
                        <td><span>20</span></td>
                        <td><span>21</span></td>
                        <td><span>22</span></td>
                        <td><a href="#">23</a></td>
                        <td><span>24</span></td>
                    </tr>
                    <tr>
                        <td><a href="#">25</a></td>
                        <td><span>26</span></td>
                        <td><span>27</span></td>
                        <td><span>28</span></td>
                        <td class="pad" colspan="3"><span>&nbsp;</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section> -->

    <!-- Copyright -->
    <div id="copyright">
        <p>
            &copy; 2014 Paul Fenwick<br />
            Design: <a href="http://html5up.net/">HTML5 UP</a>
        </p>
    </div>
</div>

            
        </div>
    </body>
</html>

