<!DOCTYPE html>
<!--
    Based upon Striped 2.5 by HTML5 Up!
    html5up.net | @n33co
    Updated for Jekyll by Paul Fenwick | @pjf
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en">
    <head prefix="og: http://ogp.me/ns#">
        <title>Intruder Alert - Tracking down a rogue connection</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />

        


    <meta property="og:image" content="http://pjf.id.au/images/pjf_square.jpg"  />
    <link rel="image_src"        href="http://pjf.id.au/images/pjf_square.jpg"  />


<meta property="og:title" content="Intruder Alert - Tracking down a rogue connection"  />
<meta property="og:url"   content="http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html" />

<!-- This should be expanded to allow for 'article' types -->
<meta property="og:type"  content="website" />




    <meta name="keywords" content="advogato" />



<meta property="fb:admins" content="549169610" />


        <link rel="icon" type="image/png" href="/images/favicon.png" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"/>

        
            <link rel="alternate" type="application/rss+xml" title="All Comments" href="http://pjf.disqus.com/latest.rss"/>
        

        <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400italic,700|Open+Sans+Condensed:300,700" rel="stylesheet" />
        <script src="/js/jquery.min.js"></script>
        <script src="/js/skel.min.js"></script>
        <script src="/js/skel-panels.min.js"></script>
        <script src="/js/init.js"></script>
        <noscript>
            <link rel="stylesheet" href="/css/skel-noscript.css" />
            <link rel="stylesheet" href="/css/style.css" />
            <link rel="stylesheet" href="/css/style-desktop.css" />
            <link rel="stylesheet" href="/css/style-wide.css" />
        </noscript>
        <!--[if lte IE 9]><link rel="stylesheet" href="css/ie9.css" /><![endif]-->
        <!--[if lte IE 8]><script src="js/html5shiv.js"></script><link rel="stylesheet" href="css/ie8.css" /><![endif]-->
        <!--[if lte IE 7]><link rel="stylesheet" href="css/ie7.css" /><![endif]-->

        <!-- TODO: Only load on fancybox pages -->
<link rel="stylesheet" href="/fancybox/source/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />
<script type="text/javascript" src="/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


        <link rel="stylesheet" href="/css/pygments.css" />
        <link rel="stylesheet" href="/css/pjf.css" />

    </head>
    <!--
        Note: Set the body element's class to "left-sidebar" to position the sidebar on the left.
        Set it to "right-sidebar" to, you guessed it, position it on the right.
    -->
    <body class="left-sidebar">
    
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-47199716-1']);
  _gaq.push(['_gat._anonymizeIp']); // Better user privacy
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


        <div id="wrapper">
            <div id="content">
                <div id="content-inner">
                    
    


<article class="is-post">
    <header>
    

    <h2>Intruder Alert - Tracking down a rogue connection</h2>
    
        <!-- This makes G+ bots happy -->
        <span class="byline">By Paul Fenwick</span>
    
    <p class="edit-post">
(You can <a href="https://github.com/pjf/pjf.github.io/edit/build/advogato/_posts/2007-11-21-intruder-alert---tracking-down-a-rogue-connection.html">suggest changes</a>
to this post.)
</p>


</header>

    <div class="info">
    
    <span class="date"> <span class="month">Nov</span>
        <span class="day">21</span> <span
            class="year"><span>,</span> 2007</span>
    </span>


    <!-- Note: You can change the number of list items in "stats" to whatever you want. -->

    <!--
        <ul class="stats">
            <li><a href="#" class="fa fa-comment">16</a></li>
            <li><a href="#" class="fa fa-heart">32</a></li>
            <li><a href="#" class="fa fa-twitter">64</a></li>
            <li><a href="#" class="fa fa-facebook">128</a></li>
        </ul>
    -->
</div>


    

    <p><b>Intruder Alert - Tracking down a rogue connection</b><br />
The hosts I administer look through their logfiles each hour, looking for things that are out of the ordinary, and mailing them to me.  This is where my uncanny ability to remember leap-seconds comes from; it's not because I actually <i>care</i> about things, but because I'll get an e-mail saying that a host suddenly found itself a <i>whole second</i> out of sync with some incredibly accurate clock somewhere.  Lucky me.
<p>
Most things <i>don't</i> end up in my log digests, because most things are boring.  The things I do see are things that I either care about, or have never seen before.
<p>
A few days ago I got an e-mail that one machine was trying to contact a particular address, 172.16.45.35.  What made this noteworthy is that address is <i>unroutable</i>.  It's a reserved, private address space.  It doesn't go <i>anywhere</i> on the Internet, and it's not used by us internally, so there should be no reason to try and contact it.  The connection indicated it would have been an outgoing web request, and since I was busy working on other things, I assumed that some other fool had set up <i>their</i> system incorrectly, and thought nothing of it.  People leave references to their own internal sites in documents all the time.
<p>
A few days later I got another e-mail, same result.  And then another, the next day, and another.  Each time I looked a little closer.  About the same time each day, a few attempts to contact this address, and then nothing.
<p>
Today, this bothered me.  What if we're seeing these packets because there's something running on this machine that shouldn't be?  So I go to my proxy logs, and do a search for the address.  Nothing matches.
<p>
Hmm, that's odd.  Let's see what's in our name-server cache, since the address is probably the result of a name lookup.  <tt>kill -INT</tt> on your <tt>named</tt> will let you see its memory cache, a great trick to remember.  Nothing in here, either, but it's now been hours since I got the mail, so the record may well have expired.
<p>
What's odd about this connection is that it seems to happen around lunchtime, but not every day, and not always exactly the same time, and sometimes it misses days, so I don't really know if or when I'll ever see it again.  Rather than trying to futilely trying to find it <i>minutes</i> after it occurs, I figure that I'll set something running to catch it in the act:

<blockquote>
<tt>lsof -r1 +c0 -ni@172.16.45.35 | grep --line-buffered -v ======= | tee 172.16.45.35-watch</tt>
</blockquote>
<p>
Every second I'll look for anything involving that address using <tt>lsof</tt>, remove the boring separators, and chuck it into a file and STDOUT.  The <tt>--line-buffered</tt> option is important so that <tt>grep</tt> doesn't delay the flow of data.
<p>
While I've got that running, I whip up a bit of perl to watch the output, and grab fingerprints of the process when we spot it; most of the contents of the relevant entry in <tt>/proc</tt> will do nicely.
<p>
I leave my tools to run in a <tt>screen</tt> session (which will preserve them even if my terminal goes away), make dinner, have an extremely nice home-brew beer, and watch some TV.  In this case, House MD.
<p>
As is common in many episodes of House, the patient is sick with a disease that <i>should</i> have been obvious, since they test for that particular disease in every single episode (expect this one).  Not long afterwards, it dawns upon me what <i>my</i> problem may be.
<p>
I go to the proxy logs, and I look up <i>all</i> the addresses of <i>all</i> the sites accessed today:

<blockquote><tt>
perl -pe'my @f = split(/\s+/,$_); $_ = $f[6]; s{^http://}{}; s{[:/].*}{}; $_ .= "\n"' access.log | sort | uniq | perl -MIO::Handle -MNet::DNS -e'my $dns = Net::DNS::Resolver-&gt;new; STDOUT-&gt;autoflush(1); while (&lt;&gt;) { chomp; print "== $_ ==\n"; my $q = $dns-&gt;search($_); if ($q) { foreach my $rr ($q-&gt;answer) { print $rr-&gt;address,"\n" if $rr-&gt;type eq "A" } } else { warn $dns-&gt;errorstring; } }' | tee /tmp/squid-dns
</tt></blockquote>
<p>
Sure enough, after a few moments my answer pops out!  The address <tt>proof.smh.com.au</tt> resolves to 172.16.45.35.  SMH is the Sydney Morning Herald, and it looks like some of their pages refer to an internal machine, which my reporting system is dutifully reporting as odd.  Sure enough, all the dates and times in the squid logfiles match up nicely with the packet intercept reports I was sent.
<p>
The reason it wasn't showing up when I first searched is that squid only records IP addresses when it needs to make a direct connection.  In this case, it <i>tried</i> to make the connection and failed, but rather than giving up it then proceeds to try and hand the problem off to an upstream cache, and <i>that's</i> what gets reporting in the logfile.
<p>
This is good for me, since it means that the odd connections really are what I thought they would be, and not a sign of unwanted activity on one of my machines.  I'm doubly glad because it would be especially embarrassing to find a rootkit that's so badly written that it tries connecting to a completely unroutable address.


    <div class="share-container">
    <div class="share-buttons">
        <p>Share:</p>
        <a href="https://www.facebook.com/sharer/sharer.php?u=http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
        <a href="https://twitter.com/intent/tweet?text=Intruder Alert - Tracking down a rogue connection (by @pjf):&amp;url=http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html" target="_blank"><i class="fa fa-twitter-square fa-2x"></i></a>
        <a href="https://www.linkedin.com/shareArticle?url=http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html" target="_blank"><i class="fa fa-linkedin-square fa-2x"></i></a>
        <a href="https://plus.google.com/share?url=http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html&amp;hl=en-GB" target="_blank"><i class="fa fa-google-plus-square fa-2x"></i></a>
        <a href="http://pinterest.com/pin/create/button/?url=http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html&amp;description=&amp;media=http://pjf.id.au" target="_blank"><i class="fa fa-pinterest-square fa-2x"></i></a>
    </div>
    <div class="share-buttons pull-right">
        <p>Subscribe:</p>
        
            <a href="https://twitter.com/pjf"><i class="fa fa-twitter-square fa-2x"></i></a>
        
        
            <a href="https://facebook.com/paul.fenwick"><i class="fa fa-facebook-square fa-2x"></i></a>
        
        <a href="/feed.xml"><i class="fa fa-rss-square fa-2x"></i></a>
    </div>
</div>


    

<div class="amplify">
    <i class="fa fa-quote-left fa-2x pull-left fa-border darker"></i>
    <h4><a href="http://bit.ly/1bABN6P">3 Myths That Block Progress For The Poor</a></h4>
    <p><a  href="http://bit.ly/1bABN6P" class="plain darker">
    The belief that the world can’t solve extreme poverty and disease isn’t
    just mistaken. It is harmful. &nbsp;&nbsp;</a>
    <a href="http://bit.ly/1bABN6P">Read more...</a>
    </p>
</div>


    

    
<div class="tip-box">
    <p>
        <img class="pull-right bitcoin" src="/images/bitcoin-qr.png" alt="Bitcoin QR code" />
        <a href="https://gittip.com/pjf"><i class="fa fa-gittip fa-3x pull-left"></i></a>
        This site is ad-free, and all my writing can be modified and re-used under
        a <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 license</a>.
        If you'd like to support my work, please 
        <a href="https://gittip.com/pjf">tip me on GitTip</a>,
        or <a href="bitcoin:1P9iGHMiQwRrnZuA6USp5PNSuJrEcH411f">donate via Bitcoin</a> (1P9iGHMiQwRrnZuA6USp5PNSuJrEcH411f).
    </p>
</div>



    

<div id="disqus_thread"></div>
<script type="text/javascript">

    var disqus_shortname  = "pjf"; 
    var disqus_identifier = "/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html";
    var disqus_title      = "Intruder Alert - Tracking down a rogue connection";
    var disqus_url        = "http://pjf.id.au/advogato/2007/11/21/intruder-alert---tracking-down-a-rogue-connection.html";

    /* Make sure that once disqus renders, we trigger any events that
     * need to happen on page resize. Otherwise our left-bar looks funny. */

    function disqus_config() {
        this.callbacks.onReady.push(function() {
            var $sc = $('#sidebar, #content');

if (skel.isActive('mobile') || skel.isActive('narrower'))
    $sc.css('min-height', '0').css('height', 'auto');
else
    $sc.css('min-height', $(window).height()).css('height', $(document).height());


        });

        this.callbacks.onNewComment.push(function() {
            var $sc = $('#sidebar, #content');

if (skel.isActive('mobile') || skel.isActive('narrower'))
    $sc.css('min-height', '0').css('height', 'auto');
else
    $sc.css('min-height', $(window).height()).css('height', $(document).height());


        });
    }

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




</article>


                    


                </div>
            </div>

            <!-- Sidebar -->
<div id="sidebar">
    <!-- Logo -->
    <div id="logo"><h1><a href="/">pjf</a></h1></div>

    <section class="find_me">
    
        <a href="https://twitter.com/pjf"><i class="fa fa-twitter-square  fa-3x"  ></i></a>
    
    
        <a href="https://facebook.com/paul.fenwick"><i class="fa fa-facebook-square fa-3x"  ></i></a>
    
    
        <a href="https://github.com/pjf"><i class="fa fa-github-square   fa-3x"  ></i></a>
    
    <br />
    
        <a href="https://flickr.com/photos/pfenwick"><i class="fa fa-flickr fa-3x"></i></a>
    
    
        <a href="https://plus.google.com/+PaulFenwick"><i class="fa fa-google-plus-square fa-3x"  ></i></a>
    
    <a href="/feed.xml"><i class="fa fa-rss-square fa-3x"></i></a>
    </section>

    <!-- Nav -->
    <nav id="nav">
        <ul>
            <!-- <li class="current_page_item"><a href="/"></a></li> -->
            <li><a href="/">Latest Posts</a></li>
        
            <li><a href="/talks">Talks</a></li>
        
            <li><a href="/ethics">Ethics</a></li>
        
            <li><a href="/tech">Technology</a></li>
        
            <li><a href="/depression">Depression</a></li>
        
            <li><a href="/df">Dwarf Fortress</a></li>
        
            <li><a href="/advogato">Older Posts</a></li>
        
        </ul>
    </nav>

    
        <section class="is-search">
            <form id="cse-search-box" action="http://google.com/cse">
            <input type="hidden" name="cx" value="partner-pub-5040518412301671:2427815553" />
            <input type="hidden" name="ie" value="UTF-8" />
            <input class="text" type="text" name="q" placeholder="Search" />
        </form>
        Search powered by Google.
        </section>
    

    <!-- Text -->
    <section class="is-text-style1">
        <div class="inner">
            <p>
            
                <a href="https://gittip.com/pjf">
                    <i class="fa fa-gittip fa-3x pull-left"></i>
                </a>
            
                Everything on this site is free for you to use
                under the <a href="https://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0</a> license.
            </p>
        </div>
    </section>

    <!-- Recent Posts -->
    <section class="is-recent-posts">
        <header>
            <h2>Recent Posts</h2>
        </header>

        <ul>
        
            <li><a href="/tech/2014/02/09/automate-your-life-with-exobrain.html">Automate Your Life With Exobrain</a>
        
            <li><a href="/personal/2014/02/07/remembering-aaron-swartz.html">Remembering Aaron Swartz</a>
        
            <li><a href="/ethics/2014/02/04/tolerance-now-maximises-sharehold-value.html">Tolerance, not bigotry, now maximises shareholder value</a>
        
            <li><a href="/ethics/2014/01/31/one-thing-can-make-the-world-a-better-place.html">One Thing Can Make The World A Better Place</a>
        
            <li><a href="/ethics/2014/01/30/one-favour.html">I have a favour to ask.</a>
        
            <li><a href="/tech/2014/01/29/learn-everything-without-spending-time.html">How to learn everything, without spending any time</a>
        
            <li><a href="/personal/2014/01/28/my-advice-for-today.html">Don't read social media</a>
        
            <li><a href="/ethics/2014/01/25/how-to-screw-learning-with-one-simple-belief.html">How to screw learning with one simple belief</a>
        
            <li><a href="/tech/2014/01/23/dont-read-articles--listen-to-them.html">Don't read articles, listen to them</a>
        
            <li><a href="/tech/2014/01/23/automated-backups-with-udev-and-btrfs.html">Automated backups with udev and btrfs</a>
        
        </ul>
    </section>

    <!-- Recent Comments -->
    <!-- <section class="is-recent-comments">
        <header>
            <h2>Recent Comments</h2>
        </header>
        <ul>
            <li>case on <a href="#">Now Full Cyborg</a></li>
            <li>molly on <a href="#">Untitled Post</a></li>
            <li>case on <a href="#">Temporal Flux</a></li>
        </ul>
    </section> -->

    <!-- Calendar -->

    <!-- <section class="is-calendar">
        <div class="inner">
            <table>
                <caption>February 2013</caption>
                <thead>
                    <tr>
                        <th scope="col" title="Monday">M</th>
                        <th scope="col" title="Tuesday">T</th>
                        <th scope="col" title="Wednesday">W</th>
                        <th scope="col" title="Thursday">T</th>
                        <th scope="col" title="Friday">F</th>
                        <th scope="col" title="Saturday">S</th>
                        <th scope="col" title="Sunday">S</th>
                    </tr>
            </thead>
            <tbody>
                    <tr>
                        <td colspan="4" class="pad"><span>&nbsp;</span></td>
                        <td><span>1</span></td>
                        <td><span>2</span></td>
                        <td><span>3</span></td>
                    </tr>
                    <tr>
                        <td><span>4</span></td>
                        <td><span>5</span></td>
                        <td><a href="#">6</a></td>
                        <td><span>7</span></td>
                        <td><span>8</span></td>
                        <td><span>9</span></td>
                        <td><a href="#">10</a></td>
                    </tr>
                    <tr>
                        <td><span>11</span></td>
                        <td><span>12</span></td>
                        <td><span>13</span></td>
                        <td class="today"><a href="#">14</a></td>
                        <td><span>15</span></td>
                        <td><span>16</span></td>
                        <td><span>17</span></td>
                    </tr>
                    <tr>
                        <td><span>18</span></td>
                        <td><span>19</span></td>
                        <td><span>20</span></td>
                        <td><span>21</span></td>
                        <td><span>22</span></td>
                        <td><a href="#">23</a></td>
                        <td><span>24</span></td>
                    </tr>
                    <tr>
                        <td><a href="#">25</a></td>
                        <td><span>26</span></td>
                        <td><span>27</span></td>
                        <td><span>28</span></td>
                        <td class="pad" colspan="3"><span>&nbsp;</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section> -->

    <!-- Copyright -->
    <div id="copyright">
        <p>
            &copy; 2014 Paul Fenwick<br />
            Design: <a href="http://html5up.net/">HTML5 UP</a><br />
            Site Based On: <a href="https://github.com/pjf/pjf.github.io">pjf.github.io</a>
        </p>
    </div>
</div>

            
        </div>
    <!-- TODO: Only load on fancybox pages -->
<script type="text/javascript">
    $(document).ready(function() {
        $(".fancybox").fancybox({
            closeClick: true,
            closeBtn: false,
            arrows: false,
            mouseWheel: false,
        });
    });
</script>


<!--[if !(lte IE 8)]><!--> 
<script type="text/javascript"> 

    

    (function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src=document.location.protocol+"//d1agz031tafz8n.cloudfront.net/thedaywefightback.js/widget.min.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})()
</script>
<!--<![endif]-->



    </body>
</html>

